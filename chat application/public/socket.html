<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Chat Application</title>
        <script type="text/javascript" src="/socket.io/socket.io.js"></script> 
        <!--The above library(/socket.io/socket.io.js) will be generated by socket.io module of server -->
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script> 
    </head>

    <body>
        <form id="nameform">
			<h1>Welcome to chat application</h1>
            <input type="text" id="name" /> <!--text form to send data to the server-->
            <input id="submitname" type="button" value="Enter your name">   


        </form>

        <form id="msgform">
<h1 align="center"><u><i>Chat Application</i></u></h1>
            <!--<input type="text" id="message" /> <!--text form to send data to the server-->
            <!--<input id="submit" type="button" value="Send data to All the Online Users">-->
            <div id="content"></div> <!--This is where the data from the server is added-->
            <div id="onlineusers"  style="background-color: lightgrey;width: 300px;padding: 10px;border: 10px navy;margin: 10px;position:absolute;right:10px;top :10px;"></div> 
            <div id="tips" > </div>

            <div>
            </div>
            <!--<div id="user1"  style="background-color: lightgrey;width: 300px; margin-top:50px; margin-left:20px; padding: 100px;border: 10px navy;margin: 10px; display:none;"></div> -->
            <!--<div id="user2"  style="background-color: lightgrey;width: 300px;padding: 10px;border: 10px navy;margin: 10px"></div> -->
        </form>



        <script type="text/javascript">
            var username1;
            var socket = io.connect("/");
            document.getElementById("msgform").style.display = "none";
            document.getElementById("onlineusers").style.display = "none";
            //   document.getElementById("user1").style.display = "none";

            /*Initializing the connection with the server via websockets */
            socket.on("message", function(message) {
                /*
                 When server sends data to the client it will trigger "message" event on the client side , by 
                 using socket.on("message") , one cna listen for the ,message event and associate a callback to 
                 be executed . The Callback function gets the dat sent from the server 
                 */
                console.log("Message from the server arrived")
                message = JSON.parse(message);
                console.log(message); /*converting the data into JS object */
                $('#content').append('<div >' + message.data + '</div>'); /*appending the data on the page using Jquery */

                document.getElementById("onlineusers").style.display = "block";
                $('#onlineusers').empty();
                $('#onlineusers').append('<h3>' + "online user list :- " + '</h3>');
                for (var i = 0; i < message.userlist.length; i++) {
                    $('#onlineusers').append('<br />');
                    $('#onlineusers').append('<label class="testclass" id="' + message.userlist[i] + '" style="cursor:pointer"  name="' + message.userlist[i] + '" onclick="submitchat(\'' + message.userlist[i] + '\')"  >' + message.userlist[i] + '</label>');
                }


            });
			
			socket.on("user_disconnect", function(message) {
                /*
                 When server sends data to the client it will trigger "message" event on the client side , by 
                 using socket.on("message") , one cna listen for the ,message event and associate a callback to 
                 be executed . The Callback function gets the dat sent from the server 
                 */
                console.log("Message from the server arrived")
                message = JSON.parse(message);
                console.log(message); /*converting the data into JS object */
                $('#content').append('<div >' + message.data + '</div>'); /*appending the data on the page using Jquery */

                document.getElementById("onlineusers").style.display = "block";
                $('#onlineusers').empty();
                $('#onlineusers').append('<h3>' + "online user list :- " + '</h3>');
                for (var i = 0; i < message.userlist.length; i++) {
                    $('#onlineusers').append('<br />');
                    $('#onlineusers').append('<label class="testclass" id="' + message.userlist[i] + '" style="cursor:pointer"  name="' + message.userlist[i] + '" onclick="submitchat(\'' + message.userlist[i] + '\')"  >' + message.userlist[i] + '</label>');
                }
				
				var disconnectuser = message.disconnected_user;
				var usrname = $('#name').val();
				$('#'+usrname+'_'+disconnectuser).hide();
				$('#'+disconnectuser+'_'+usrname).hide();


            });
			
            socket.on("chat_send", function(message) {
                message = JSON.parse(message);
                var message_sent = message.data;
                var from_to = message.from_to;
                var arr = from_to.split("_");
				console.log("chat_send from the server arrived");
                console.log(message);
                if ((arr[0] == $('#name').val()) || (arr[1] == $('#name').val())) {
                    var message_sent = message.data;
                    var from_to = message.from_to;
                    var arr = from_to.split("_");
                    var to_from = arr[1] + "_" + arr[0];
                    var true_from_to = false;
                    var true_to_from = false;
                    var neither_to_nor_from = false;
                    if ((document.getElementById(from_to)) || (document.getElementById(to_from))) {
                        if ((document.getElementById(from_to))) {
                            true_from_to = true;
							$('#'+from_to).show();
                            $('#chatcontent' + from_to).append('<h3>' + message_sent + '</h3>');
                        } else if ((document.getElementById(to_from))) {
						$('#'+to_from).show();
                            true_to_from = true;
                            $('#chatcontent' + to_from).append('<h3>' + message_sent + '</h3>');
                        } else {
                            neither_to_nor_from = true;
                            $('#msgform').append('<div id="' + from_to + '" style="background-color: lightgrey; width:300px; max-width:300px; margin-top:10px; margin-left:5px; display: block;"></div>');
                            $('#'+ from_to ).append('<div style="display:inline"><b><u><i>'+arr[0]+'</i></u></b></div>');
							$('#'+ from_to ).append('<div id="chatcontent' + from_to + '" style=" max-height: 600px; overflow-y: auto;"></div>');
                            $('#'+ from_to ).append('<div style="padding-top:300px;"></div>');
                            $('#'+ from_to ).append('<div style="display:inline"><input type="text" name="chat_' + from_to + '" id="chat_' + from_to + '"/></div>');
                            $('#'+ from_to ).append('<div style="display:inline"><input type="button"  id="send_' + from_to + '" value="Send" onclick="sendchat(\'' + to_from + '\')"/></div>');
                            $('#chat_' + from_to).val(message_sent) ; 
							$('#chatcontent' + from_to).append('<h3>' + message_sent + '</h3>');
							$('#chat_' + from_to).val('');
				$('#chat_' + to_from).val('');
                        }



                    }else{
							neither_to_nor_from = true;
                            $('#msgform').append('<div id="' + from_to + '" style="background-color: lightgrey; width:300px; max-width:300px; margin-top:10px; margin-left:5px; display: block;"></div>');
                             $('#'+ from_to ).append('<div style="display:inline"><b><u><i>'+arr[0]+'</i></u></b></div>');
							$('#'+ from_to ).append('<div id="chatcontent' + from_to + '" style=" max-height: 600px; overflow-y: auto;"></div>');
                            $('#'+ from_to ).append('<div style="padding-top:300px;"></div>');
                            $('#'+ from_to ).append('<div style="display:inline"><input type="text" name="chat_' + from_to + '" id="chat_' + from_to + '"/></div>');
                            $('#'+ from_to ).append('<div style="display:inline"><input type="button"  id="send_' + from_to + '" value="Send" onclick="sendchat(\'' + to_from + '\')"/></div>');
							$('#chat_' + from_to).val(message_sent) ;                          
						   $('#chatcontent' + from_to).append('<h3>' + message_sent + '</h3>');
						   $('#chat_' + from_to).val('');
				$('#chat_' + to_from).val('');
					
					}
                }





            });
            $(function() {
                $('#submit').click(function() { /*listening to the button click using Jquery listener*/
                    var data = $('#message').val();
                    socket.send(data);
                    /*Data can be sent to server very easily by using socket.send() method 
                     The data has to be changed to a JSON before sending
                     it (JSON.stringify() does this job )*/
                    /* This triggers a message event on the server side 
                     and the event handler obtains the data sent */

                    $('#message').val('');
                    //Emptying the text box value using jquery 

                });
                $('#submitname').click(function() { /*listening to the button click using Jquery listener*/
                    var data = $('#name').val();
                    //alert("hello " + data);
                    var name_to_server = {
                        username: data
                    };
                    socket.send(JSON.stringify(name_to_server));
                    document.getElementById("nameform").style.display = "none";
                    document.getElementById("msgform").style.display = "block";
                });
                $('#send').click(function() { /*listening to the button click using Jquery listener*/
                    //alert("msg send");
                    var name_to_server = {
                        username: "hii"
                    };
                    socket.send(JSON.stringify(name_to_server));
                    $('#chatcontent').append('<h3>' + $('#chat').val() + '</h3>');
                    $('#chat').val('');
                });
            });
            function sendchat(from_to) {
                
				var arr = from_to.split("_");
                    var to_from = arr[1] + "_" + arr[0];
					var msg;
				
				if((document.getElementById("chat_"+from_to))){
				msg = $('#chat_' + from_to).val();
				}else if((document.getElementById("chat_"+to_from))){
				msg = $('#chat_' + to_from).val();
				}
                var name_to_server = {
                    from_to: from_to,
                    msg_send: msg
                };
                socket.send(JSON.stringify(name_to_server));
                //$('#chatcontent' + from_to).append('<h3>' + msg + '</h3>');
                $('#chat_' + from_to).val('');
				$('#chat_' + to_from).val('');
            }


            function submitchat(username) {
              
			  
                var data = $('#name').val();

if((document.getElementById(data + '_' + username))){
//alert("alreadyexists");
				$('#'+data + '_' + username).show();
							
}else if((document.getElementById(username + '_' + data))){
//alert("alreadyexists1");
				$('#'+usrname+'_'+data).show();
					
}else{
			  $('#msgform').append('<div id="' + data + '_' + username + '" style="background-color: lightgrey; width:300px; max-width:300px; margin-top:10px; margin-left:5px; display: block;"></div>');
				$('#'+ data + '_' + username ).append('<div style="display:inline"><b><u><i>'+username+'</i></u></b></div>');
                 $('#'+ data + '_' + username ).append('<div id="chatcontent' + data + '_' + username + '" style=" max-height: 600px; overflow-y: auto;"></div>');
                 $('#'+ data + '_' + username ).append('<div style="padding-top:300px;"></div>');
                 $('#'+ data + '_' + username ).append('<div style="display:inline"><input type="text" name="chat_' + data + '_' + username + '" id="chat_' + data + '_' + username + '"/></div>');
                 $('#'+ data + '_' + username ).append('<div style="display:inline"><input type="button"  id="send_' + data + '_' + username + '" value="Send" onclick="sendchat(\'' + data + '_' + username + '\')"/></div>');
         }   }

        </script>


    </body>
</html>